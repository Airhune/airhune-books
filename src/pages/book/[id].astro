---
import Layout from "../../layouts/Layout.astro";

const { id } = Astro.params;

/*Book info*/
const book_response = await fetch(`https://www.googleapis.com/books/v1/volumes/${encodeURIComponent(id)}`);
const book = await book_response.json();

const categories = book.volumeInfo.categories?.[0]?.split("/").map((cat) => cat.trim()) || [];

const formatDate = (dateStr) => {
  if (!dateStr) return "";
  const [year, month, day] = dateStr.split("-");
  return `${day}/${month}/${year}`;
};

const publishedDate = book.volumeInfo.publishedDate ? formatDate(book.volumeInfo.publishedDate): "No disponible";

/*Related books*/
const author = book.volumeInfo.authors?.[0];
const related_response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=inauthor:${author}&maxResults=5`);
const related = await related_response.json();
const relatedBooks = related.items || [];

---

<Layout title={`${book.volumeInfo.title} - Airhune Books`}>
    <h2 class="text-3xl md:text-4xl font-bold text-white mb-10 mt-20 text-center">
        {book.volumeInfo.title}
    </h2>

    <div class="bg-white/10 backdrop-blur-lg p-6 md:p-8 rounded-2xl shadow-xl flex flex-col md:flex-row gap-6 md:gap-8 transform">
        <div class="w-full md:w-1/3 flex-shrink-0">
        {
            book.volumeInfo.imageLinks?.thumbnail ? (
                <div class="w-auto h-[700px] md:h-[450px] overflow-hidden rounded-xl shadow-lg">
                    <img src={book.volumeInfo.imageLinks.thumbnail} alt={`Portada de ${book.volumeInfo.title}`} class="w-full h-full object-cover transition-transform" />
                </div>
                ) : (
                <div class="w-full h-[300px] md:h-[450px] bg-gray-500/20 rounded-xl flex items-center justify-center text-gray-300 text-lg font-medium">
                    Sin portada
                </div>
            )
        }
        </div>

        <div class="w-full md:w-2/3 flex flex-col">
            <div>
                <p class="text-xl text-gray-200 mb-2">
                <span class="font-semibold">Author</span>
                </p>{book.volumeInfo.authors?.join(", ") || "Desconocido"}
            </div>
            <p class="text-lg text-gray-200 mb-2 mt-4">
                {publishedDate}
            </p>
            <p class="text-lg text-gray-200 mb-4 mt-4">
                {
                categories.map((category) => (
                    <span class="inline-block px-5 py-1 rounded bg-pink-200/30 mr-1">
                    {category}
                    </span>
                ))
                }
            </p>
            <p class="text-lg text-gray-200 mb-4">
                {book.volumeInfo.pageCount} pages
            </p>
            <p class="text-xl text-gray-200 font-semibold mb-2">Summary</p>
            <div class="text-gray-300 text-base leading-relaxed mb-4 line-clamp-6" set:html={book.volumeInfo?.description}></div>
        </div>
    </div>

    <div class="bg-white/10 backdrop-blur-lg p-6 md:p-8 rounded-2xl shadow-xl flex flex-col md:flex-row gap-6 md:gap-8 transform mt-10">
        <h3 class="text-2xl md:text-3xl font-bold text-white mb-10">
            Related books

            <div class="container grid gap-6 md:grid-cols-5 mt-10">
				{
					relatedBooks.map((relatedBook: any) => (
					<article class="p-4 bg-white/10 rounded-xl transition hover:scale-105">
						<a href={`/book/${relatedBook.id}`} class="pointer rounded-md mt-2 mb-4 flex justify-center items-center">
                            {
                                relatedBook.volumeInfo.imageLinks?.thumbnail ? (
                                    <img
                                    transition:name={`img-${relatedBook.id}`}
                                    src={relatedBook.volumeInfo.imageLinks?.thumbnail}
                                    alt={relatedBook.volumeInfo.title}
                                    class="w-50 max-h-75 min-h-75 rounded"
                                    />
                                ) : (
                                    <div class="w-50 max-h-75 min-h-75 bg-gray-500/20 rounded-xl flex items-center justify-center text-gray-300 text-lg font-medium">
                                    </div>
                                )
                            }
							
						</a>
						<h2 class="text-xl font-bold mt-5 mb-2 leading-tight text-center">
							{relatedBook.volumeInfo.title}
						</h2>
						<p class=" mb-2 text-center text-xl text-white">
							{relatedBook.volumeInfo.authors}
						</p>

					</article>
					))
				}
				</div>
        </h3>
    </div>
</Layout>
